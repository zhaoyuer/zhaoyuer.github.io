<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>决策树CART | 可乐不加冰</title><meta name="keywords" content="算法"><meta name="author" content="宇昭"><meta name="copyright" content="宇昭"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="定义​    定义Y(M)为M条件结果集，M|N为在M条件下N的结果集 ,A为信息结果集的维度,A1,A2,A3为维度下三个取值，BC同，P(x)为x出现的概率，Gain(x)为x的GINI指数。 概念​     大道至简。 ​     在项目实际运用中时，前2种算法弊端太多，算法时间空间耗费过大，当信息集由小到大重构耗费过大，当维度过多，维度取值过多时，前2种多叉树存储又存在问题，诸如此类。 ​">
<meta property="og:type" content="article">
<meta property="og:title" content="决策树CART">
<meta property="og:url" content="http://example.com/2020/11/18/blog-4/index.html">
<meta property="og:site_name" content="可乐不加冰">
<meta property="og:description" content="定义​    定义Y(M)为M条件结果集，M|N为在M条件下N的结果集 ,A为信息结果集的维度,A1,A2,A3为维度下三个取值，BC同，P(x)为x出现的概率，Gain(x)为x的GINI指数。 概念​     大道至简。 ​     在项目实际运用中时，前2种算法弊端太多，算法时间空间耗费过大，当信息集由小到大重构耗费过大，当维度过多，维度取值过多时，前2种多叉树存储又存在问题，诸如此类。 ​">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-11-18T08:42:46.000Z">
<meta property="article:modified_time" content="2020-12-07T03:30:43.492Z">
<meta property="article:author" content="宇昭">
<meta property="article:tag" content="算法">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/11/18/blog-4/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-12-07 11:30:43'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><link rel="stylesheet" href="/source/css/yu.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">6</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-link"></i><span> 留言板</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%97%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E6%B5%8B"><span class="toc-number">5.</span> <span class="toc-text">预测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%AA%E6%9E%9D"><span class="toc-number">6.</span> <span class="toc-text">剪枝</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text">小结</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">可乐不加冰</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-link"></i><span> 留言板</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">决策树CART</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-18T08:42:46.000Z" title="发表于 2020-11-18 16:42:46">2020-11-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-12-07T03:30:43.492Z" title="更新于 2020-12-07 11:30:43">2020-12-07</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>​    定义Y(M)为M条件结果集，M|N为在M条件下N的结果集 ,A为信息结果集的维度,A1,A2,A3为维度下三个取值，BC同，P(x)为x出现的概率，Gain(x)为x的GINI指数。</p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>​     大道至简。</p>
<p>​     在项目实际运用中时，前2种算法弊端太多，算法时间空间耗费过大，当信息集由小到大重构耗费过大，当维度过多，维度取值过多时，前2种多叉树存储又存在问题，诸如此类。</p>
<p>​    鉴于上述问题，科学家推出CART算法，分类回归树。CART决策树将维度取值分为某个取值，非某个取值,构造的决策树为二叉树。信息集含的类别越杂乱，GINI指数就越大。有<br>$$<br>Gain(x) = E[P(xi)<em>(1-P(xi))] = 1- E<a href="i=1,2,..n">P(xi)*P(xi)</a><br>$$<br>对于结果仅有2种则有<br>$$<br>Gain(x) =2P(Xi)</em>(1-P(Xi))<br>$$<br> 对于维度A则有<br>$$<br>Gain(A) =E[P(Ai)*Gain(Ai)] (i=1,2,..n)<br>$$</p>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><p>​              同ID3,只是计算数据为GINI指数。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>​     本算法在实际调研中发现有3种写法，并避免计算量过重，将数值类型取值转为整数二进制位数，</p>
<p>维度，信息集json入库。假定维度为M个。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">private static final String NUM_ZERO &#x3D; &quot;0&quot;;</span><br><span class="line">private static final String NULL &#x3D; &quot;NULL&quot;;</span><br><span class="line">private static final String UN_LEGAL &#x3D; &quot;UN_LEGAL&quot;;</span><br><span class="line">private static final String NEGATIVE_FLAG &#x3D; &quot;-&quot;;</span><br><span class="line">private static final String POINT_FLAG &#x3D; &quot;.&quot;;</span><br><span class="line">private static final Integer ZERO &#x3D; 0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 返回数字的二进制位数</span><br><span class="line"> *</span><br><span class="line"> * @param num</span><br><span class="line"> * @return</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static String toBinaryLength(String num) &#123;</span><br><span class="line">    if (StringUtils.isBlank(num))</span><br><span class="line">        return NULL;</span><br><span class="line">    num &#x3D; num.contains(POINT_FLAG) ? num.substring(ZERO, num.indexOf(POINT_FLAG)) : num;</span><br><span class="line">    if (StringUtils.equals(NUM_ZERO, num))</span><br><span class="line">        return NUM_ZERO;</span><br><span class="line">    try &#123;</span><br><span class="line">        boolean lowZero &#x3D; num.contains(NEGATIVE_FLAG);</span><br><span class="line">        num &#x3D; num.replace(NEGATIVE_FLAG, &quot;&quot;);</span><br><span class="line">        int length &#x3D; Integer.toBinaryString(Integer.valueOf(num)).length();</span><br><span class="line">        return String.valueOf(lowZero ? -length : length);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        System.out.println(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    return UN_LEGAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>  决策树节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">@Getter</span><br><span class="line">@Setter</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">public class AuditNode implements Serializable &#123;</span><br><span class="line">    private String name;&#x2F;&#x2F;节点名</span><br><span class="line">    @JSONField(serialize &#x3D; false)</span><br><span class="line">    ArrayList&lt;String&gt; label &#x3D; new ArrayList&lt;String&gt;();&#x2F;&#x2F;和子节点间的边标签</span><br><span class="line">    @JSONField(serialize &#x3D; false)</span><br><span class="line">    ArrayList&lt;AuditNode&gt; node &#x3D; new ArrayList&lt;AuditNode&gt;();&#x2F;&#x2F;对应子节点</span><br><span class="line">    @JSONField(serialize &#x3D; false)</span><br><span class="line">    List&lt;Integer&gt; indexList &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    @JSONField(serialize &#x3D; false)</span><br><span class="line">    private AuditNode parent;       &#x2F;&#x2F;父节点</span><br><span class="line">    @JSONField(serialize &#x3D; false)</span><br><span class="line">    private AuditNode leftChild;        &#x2F;&#x2F;左孩子节点</span><br><span class="line">    @JSONField(serialize &#x3D; false)</span><br><span class="line">    private AuditNode rightChild;       &#x2F;&#x2F;右孩子节点</span><br><span class="line">    @JSONField(serialize &#x3D; false)</span><br><span class="line">    private List&lt;AuditNode&gt; children;       &#x2F;&#x2F;孩子节点</span><br><span class="line"></span><br><span class="line">    private boolean beNum; &#x2F;&#x2F;是否数字维度</span><br><span class="line">    private String dimName;        &#x2F;&#x2F;维度</span><br><span class="line">    private String dimDesc;        &#x2F;&#x2F;维度描述</span><br><span class="line">    private String dimId;        &#x2F;&#x2F;维度ID</span><br><span class="line">    private String quota;        &#x2F;&#x2F;指标</span><br><span class="line">    private Double precision;       &#x2F;&#x2F;判定的正确率</span><br><span class="line">    private int record_number;      &#x2F;&#x2F;该节点上涵盖的记录个数</span><br><span class="line">    private int leafNodeNum;       &#x2F;&#x2F;子树包含的叶子节点的数目</span><br><span class="line">    private int index;      &#x2F;&#x2F;层次遍历树，给节点标上序号</span><br><span class="line">    private double alpha;   &#x2F;&#x2F;表面误差率的增加量</span><br><span class="line">    private int successNum; &#x2F;&#x2F; 成功次数</span><br><span class="line">    private int failNum;   &#x2F;&#x2F; 失败次数</span><br><span class="line">    private int allNum;   &#x2F;&#x2F; 失败次数</span><br><span class="line">    private boolean beLeft;  &#x2F;&#x2F;是否左叶子节点</span><br><span class="line">    private boolean beLeaf; &#x2F;&#x2F;是否叶子节点</span><br><span class="line">    private int leftChildNum;  &#x2F;&#x2F;左分支数</span><br><span class="line">    private int rightChildNum;  &#x2F;&#x2F;右分支数</span><br><span class="line">    private int rightChildSuccessNum; &#x2F;&#x2F;右分支成功数</span><br><span class="line">    private int leftChildSuccessNum; &#x2F;&#x2F;左分支成功数</span><br><span class="line">    private int rightChildFailNum;&#x2F;&#x2F;右分支失败数</span><br><span class="line">    private int leftChildFailNum;&#x2F;&#x2F;左分支失败数</span><br><span class="line">    private int maxIndex;   &#x2F;&#x2F;最深深度</span><br><span class="line">    private int leftLeafNum;&#x2F;&#x2F;左叶子节点数</span><br><span class="line">    private int rightLeafNum;&#x2F;&#x2F;右叶子节点数</span><br><span class="line">    private int serialSuccessNum;&#x2F;&#x2F;当前连续成功数</span><br><span class="line">    private int serialFailNum;&#x2F;&#x2F;当前连续失败数</span><br><span class="line">&#x2F;&#x2F;    private int serialLeftSuccessNum;&#x2F;&#x2F;当前连续成功数</span><br><span class="line">&#x2F;&#x2F;    private int serialLeftFailNum;&#x2F;&#x2F;当前连续失败数</span><br><span class="line">&#x2F;&#x2F;    private int serialRightSuccessNum;&#x2F;&#x2F;当前连续成功数</span><br><span class="line">&#x2F;&#x2F;    private int serialRightFailNum;&#x2F;&#x2F;当前连续失败数</span><br><span class="line"></span><br><span class="line">    private String parentAttrValue;</span><br><span class="line"></span><br><span class="line">    private String id;</span><br><span class="line">    private String parentId;</span><br><span class="line"></span><br><span class="line">    public AuditNode(String dimId, String quota, Integer successNum, Integer failNum, boolean beNum, String dimName, String dimDesc) &#123;</span><br><span class="line">        this.dimId &#x3D; dimId;</span><br><span class="line">        this.quota &#x3D; quota;</span><br><span class="line">        this.dimName &#x3D; dimName;</span><br><span class="line">        this.dimDesc &#x3D; dimDesc;</span><br><span class="line">        this.successNum &#x3D; successNum &#x3D;&#x3D; null ? 0 : successNum;</span><br><span class="line">        this.failNum &#x3D; failNum &#x3D;&#x3D; null ? 0 : failNum;</span><br><span class="line">        this.beNum &#x3D; beNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public AuditNode(String dimId, String quota, Integer successNum, Integer failNum, boolean beNum, String dimName, String dimDesc, Double precision) &#123;</span><br><span class="line">        this.dimId &#x3D; dimId;</span><br><span class="line">        this.quota &#x3D; quota;</span><br><span class="line">        this.dimName &#x3D; dimName;</span><br><span class="line">        this.dimDesc &#x3D; dimDesc;</span><br><span class="line">        this.successNum &#x3D; successNum &#x3D;&#x3D; null ? 0 : successNum;</span><br><span class="line">        this.precision &#x3D; precision;</span><br><span class="line">        this.failNum &#x3D; failNum &#x3D;&#x3D; null ? 0 : failNum;</span><br><span class="line">        this.beNum &#x3D; beNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public AuditNode clone() &#123;</span><br><span class="line">        return CommonUtils.cloneObject(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AuditNode copy() &#123;</span><br><span class="line">        AuditNode auditNode &#x3D; new AuditNode();</span><br><span class="line">        auditNode.setQuota(quota);</span><br><span class="line">        auditNode.setDimId(dimId);</span><br><span class="line">        auditNode.setDimDesc(dimDesc);</span><br><span class="line">        auditNode.setDimName(dimName);</span><br><span class="line">        auditNode.setBeLeaf(beLeaf);</span><br><span class="line">        auditNode.setBeNum(beNum);</span><br><span class="line">        return auditNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>计算维度指标的GINI系数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public void calcCDRGini(Collection&lt;List&lt;AuditNode&gt;&gt; collection, int count, int allSuccessCount) &#123;</span><br><span class="line"></span><br><span class="line">    collection.forEach(x -&gt; x.forEach(y -&gt; &#123;</span><br><span class="line">        double keySuccessCount &#x3D; y.getSuccessNum();</span><br><span class="line">        double keyFailCount &#x3D; y.getFailNum();</span><br><span class="line">        double keyCount &#x3D; keySuccessCount + keyFailCount;</span><br><span class="line"></span><br><span class="line">        double nonKeyCount &#x3D; count - keyCount;</span><br><span class="line">        double nonKeySuccessCount &#x3D; allSuccessCount - keySuccessCount;</span><br><span class="line">        double nonKeyFailCount &#x3D; nonKeyCount - nonKeySuccessCount;</span><br><span class="line"></span><br><span class="line">        double keySuccessGain &#x3D; 1 - Math.pow(keySuccessCount &#x2F; keyCount, 2) - Math.pow(keyFailCount &#x2F; keyCount, 2);</span><br><span class="line">        double nonKeySuccessGain &#x3D; 1 - Math.pow(nonKeySuccessCount &#x2F; nonKeyCount, 2) - Math.pow(nonKeyFailCount &#x2F; nonKeyCount, 2);</span><br><span class="line">        double precision &#x3D; (keyCount &#x2F; count) * keySuccessGain + (nonKeyCount &#x2F; count) * nonKeySuccessGain;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        y.setPrecision(nonKeyCount &#x3D;&#x3D; 0 || keyCount &#x3D;&#x3D; 0 ? 1 : precision);</span><br><span class="line">        &#x2F;&#x2F;    y.setPrecision(precision);</span><br><span class="line">        log.info(&quot;&#123;&#125;,&#123;&#125;,&#123;&#125;,: &#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;&quot;, y.getDimName(), y.getDimDesc(), y.getQuota(), keyCount, nonKeyCount, keySuccessCount, nonKeySuccessCount, keySuccessGain, nonKeySuccessGain, y.getPrecision());</span><br><span class="line">    &#125;));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   获取使用过的维度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void addParents(AuditNode root, List&lt;AuditNode&gt; nodes) &#123;</span><br><span class="line">    if (root.getParent() !&#x3D; null) &#123;</span><br><span class="line"></span><br><span class="line">        addParents(root.getParent(), nodes);</span><br><span class="line">        nodes.add(root);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    决策树构建过程临时节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @Desc</span><br><span class="line"> * @Author Yu Zhao</span><br><span class="line"> * @Date 2020&#x2F;11&#x2F;19 11:10</span><br><span class="line"> * @Version 1.0</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Data</span><br><span class="line">public class TreeGrowDto &#123;</span><br><span class="line"></span><br><span class="line">    private int successCount;</span><br><span class="line">    private int sum;</span><br><span class="line">    private AuditNode auditNode;</span><br><span class="line"></span><br><span class="line">    public TreeGrowDto(int successCount,  int sum, AuditNode auditNode) &#123;</span><br><span class="line">        this.successCount &#x3D; successCount;</span><br><span class="line">        this.sum &#x3D; sum;</span><br><span class="line">        this.auditNode &#x3D; auditNode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1数组构建决策树</p>
<p>​      (1) 获取全量的数据集</p>
<p>​      (2)获取当前决策树未使用的维度,若维度使用完全则结束</p>
<p>​      (3)在当前数据集计算每个维度的每个取值的GINI,汇总整个维度的GINI</p>
<p>​      (4)在3基础上选择最小的GINI系数的维度</p>
<p>​      (5)在4基础上进行树的生长</p>
<p>​      (6)在3的基础上对数据集进行切割 递归调用2</p>
<p>​      空间和时间复杂度均为O(mn)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;递归list</span><br><span class="line">    public void resetTreeByList(String platId, int treeType) &#123;</span><br><span class="line">        long start &#x3D; System.currentTimeMillis();</span><br><span class="line">        List&lt;AuditHistory&gt; auditHistories &#x3D; dao.findAll();</span><br><span class="line"></span><br><span class="line">        AuditNode root &#x3D; new AuditNode();</span><br><span class="line">        root.setId(AppConstant.ROOT);</span><br><span class="line"></span><br><span class="line">        tree &#x3D; root;</span><br><span class="line">        growTreeByList(auditHistories, root, platId);</span><br><span class="line"></span><br><span class="line">        log.info(&quot;使用全量list进行递归构建决策树耗时:&#123;&#125;&quot;, System.currentTimeMillis() - start);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void growTreeByList(List&lt;AuditHistory&gt; auditHistories, AuditNode root, String platId) &#123;</span><br><span class="line">        if (root &#x3D;&#x3D; null)</span><br><span class="line">            return;</span><br><span class="line"></span><br><span class="line">        TreeUtils.print(tree);</span><br><span class="line">        List&lt;AuditNode&gt; nodes &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        addParents(root, nodes);</span><br><span class="line">        if (nodes.size() &gt; 21)</span><br><span class="line">            return;</span><br><span class="line">        TreeGrowDto treeGrowDto &#x3D; getNode(platId, nodes, auditHistories, cart);</span><br><span class="line">        AuditNode leftChild &#x3D; treeGrowDto.getAuditNode();</span><br><span class="line">        leftChild.setBeLeft(true);</span><br><span class="line">        int successCount &#x3D; treeGrowDto.getSuccessCount();</span><br><span class="line">        int sum &#x3D; treeGrowDto.getSum();</span><br><span class="line"></span><br><span class="line">        if (sum &#x3D;&#x3D; 0)</span><br><span class="line">            return;</span><br><span class="line"></span><br><span class="line">        int leftSuccessCount &#x3D; leftChild.getSuccessNum();</span><br><span class="line">        int leftFailCount &#x3D; leftChild.getFailNum();</span><br><span class="line">        int rightSuccessCount &#x3D; successCount - leftSuccessCount;</span><br><span class="line">        int rightFailCount &#x3D; sum - successCount - leftFailCount;</span><br><span class="line"></span><br><span class="line">        log.error(&quot;sum:&#123;&#125; successCount:&#123;&#125; leftSuccessCount:&#123;&#125; leftFailCount:&#123;&#125; rightSuccessCount:&#123;&#125; rightFailCount:&#123;&#125;  &quot;, sum, successCount, leftSuccessCount, leftFailCount, rightSuccessCount, rightFailCount);</span><br><span class="line">        root.setLeftChildNum(leftSuccessCount + leftFailCount);</span><br><span class="line">        root.setRightChildNum(rightFailCount + rightSuccessCount);</span><br><span class="line"></span><br><span class="line">        if (rightSuccessCount !&#x3D; 0 || rightFailCount !&#x3D; 0) &#123;</span><br><span class="line">            AuditNode rightChild &#x3D; leftChild.copy();</span><br><span class="line">            rightChild.setSuccessNum(rightSuccessCount);</span><br><span class="line">            rightChild.setFailNum(rightFailCount);</span><br><span class="line">            rightChild.setBeLeft(false);</span><br><span class="line">            root.setRightChild(rightChild);</span><br><span class="line">            rightChild.setParent(root);</span><br><span class="line">            growTreeByList(getList(root.getRightChild(), auditHistories, false), root.getRightChild(), platId);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        leftChild.setParent(root);</span><br><span class="line">        root.setLeftChild(leftChild);</span><br><span class="line"></span><br><span class="line">        growTreeByList(getList(root.getLeftChild(), auditHistories, true), root.getLeftChild(), platId);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private List&lt;AuditHistory&gt; getList(AuditNode x, List&lt;AuditHistory&gt; auditHistories, boolean beLeft) &#123;</span><br><span class="line">        if (x.isBeNum()) &#123;</span><br><span class="line">            double start &#x3D; Math.pow(2, Integer.valueOf(x.getQuota()) - 1);</span><br><span class="line">            double end &#x3D; Math.pow(2, Integer.valueOf(x.getQuota()));</span><br><span class="line"></span><br><span class="line">            return beLeft ? auditHistories.stream().filter(t -&gt; &#123;</span><br><span class="line">                double target &#x3D; JSONObject.parseObject(t.getPersonas()).getDoubleValue(x.getDimName());</span><br><span class="line">                return start &lt;&#x3D; target &amp;&amp; target &lt; end;</span><br><span class="line">            &#125;).collect(Collectors.toList()) :</span><br><span class="line">                    auditHistories.stream().filter(t -&gt; &#123;</span><br><span class="line">                        double target &#x3D; JSONObject.parseObject(t.getPersonas()).getDoubleValue(x.getDimName());</span><br><span class="line">                        return end &lt; target || target &lt; start;</span><br><span class="line">                    &#125;).collect(Collectors.toList())</span><br><span class="line">                    ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F;其他类型 直接比较维度取值</span><br><span class="line">            return beLeft ? auditHistories.stream().filter(t -&gt; StringUtils.equals(JSONObject.parseObject(t.getPersonas()).getString(x.getDimName()), x.getQuota())).collect(Collectors.toList()) :</span><br><span class="line">                    auditHistories.stream().filter(t -&gt; !StringUtils.equals(JSONObject.parseObject(t.getPersonas()).getString(x.getDimName()), x.getQuota())).collect(Collectors.toList())</span><br><span class="line">                    ;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private TreeGrowDto getNode(String platId, List&lt;AuditNode&gt; nodes, List&lt;AuditHistory&gt; auditHistories, Cart algorithm) &#123;</span><br><span class="line">        &#x2F;&#x2F;平台全部可用维度</span><br><span class="line">        Map&lt;String, AuditDimension&gt; auditDimensions &#x3D; AppCnst.PLAT_DIM_CACHE.get(platId).stream().collect(Collectors.toMap(AuditDimension::getId, AuditDimension -&gt; AuditDimension));</span><br><span class="line">        &#x2F;&#x2F;决策树已存在的维度ID</span><br><span class="line">        List&lt;String&gt; existNodeDimIds &#x3D; nodes.stream().map(AuditNode::getDimId).collect(Collectors.toList());</span><br><span class="line">        &#x2F;&#x2F;决策树尚未使用的维度ID</span><br><span class="line">        &#x2F;&#x2F;  List&lt;AuditDimension&gt;   unUsedDims&#x3D; auditDimensions.values().stream().filter(x-&gt;!existNodeDimIds.contains(x.getId())).collect(Collectors.toList());</span><br><span class="line">        Map&lt;AuditDimension, List&lt;AuditPlatformQuota&gt;&gt; unUsedDimQuotaMap &#x3D; AppCnst.PLAT_FORM_QUOTA_CACHE.get(platId).entrySet().stream().filter(x -&gt; !existNodeDimIds.contains(x.getKey())).collect(Collectors.toMap(x -&gt; auditDimensions.get(x.getKey()), Map.Entry::getValue));</span><br><span class="line">        Collection&lt;List&lt;AuditNode&gt;&gt; result &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        long start2 &#x3D; System.currentTimeMillis();</span><br><span class="line">        long successSum &#x3D; auditHistories.stream().filter(x -&gt; x.getAuditResult() &#x3D;&#x3D; 1 || x.getAuditResult() &#x3D;&#x3D; 3).count();</span><br><span class="line">        int sum &#x3D; auditHistories.size();</span><br><span class="line"></span><br><span class="line">        log.info(&quot;sum:&#123;&#125;&quot;, sum);</span><br><span class="line">        log.info(&quot;successSum:&#123;&#125;&quot;, successSum);</span><br><span class="line">        &#x2F;&#x2F;遍历未使用的维度</span><br><span class="line">        unUsedDimQuotaMap.forEach((x, z) -&gt; &#123;</span><br><span class="line">            List&lt;AuditNode&gt; auditNodes &#x3D; new ArrayList&lt;&gt;(z.size());</span><br><span class="line"></span><br><span class="line">            z.forEach(y -&gt; &#123;</span><br><span class="line">                &#x2F;&#x2F;数字类型参数 将维度取值进行2的阶乘 进行比较</span><br><span class="line">                if (x.getBeNum()) &#123;</span><br><span class="line">                    double start &#x3D; Math.pow(2, Integer.valueOf(y.getQuota()) - 1);</span><br><span class="line">                    double end &#x3D; Math.pow(2, Integer.valueOf(y.getQuota()));</span><br><span class="line"></span><br><span class="line">                    long filterSum &#x3D; auditHistories.stream().filter(t -&gt; &#123;</span><br><span class="line">                        double target &#x3D; JSONObject.parseObject(t.getPersonas()).getDoubleValue(auditDimensions.get(x.getId()).getDimName());</span><br><span class="line">                        return start &lt;&#x3D; target &amp;&amp; target &lt; end;</span><br><span class="line">                    &#125;).count();</span><br><span class="line">                    long successNum &#x3D; auditHistories.stream().filter(t -&gt; &#123;</span><br><span class="line">                        double target &#x3D; JSONObject.parseObject(t.getPersonas()).getDoubleValue(auditDimensions.get(x.getId()).getDimName());</span><br><span class="line">                        return start &lt;&#x3D; target &amp;&amp; target &lt; end &amp;&amp; (t.getAuditResult() &#x3D;&#x3D; 1 || t.getAuditResult() &#x3D;&#x3D; 3);</span><br><span class="line">                    &#125;).count();</span><br><span class="line"></span><br><span class="line">                    auditNodes.add(new AuditNode(x.getId(), y.getQuota(), (int) successNum, (int) (filterSum - successNum), x.getBeNum(), x.getDimName(), x.getDimDesc()));</span><br><span class="line"></span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F;其他类型 直接比较维度取值</span><br><span class="line">                    long filterSum &#x3D; auditHistories.stream().filter(t -&gt; StringUtils.equals(JSONObject.parseObject(t.getPersonas()).getString(auditDimensions.get(x.getId()).getDimName()), y.getQuota())).count();</span><br><span class="line"></span><br><span class="line">                    long successNum &#x3D; auditHistories.stream().filter(t -&gt; StringUtils.equals(JSONObject.parseObject(t.getPersonas()).getString(auditDimensions.get(x.getId()).getDimName()), y.getQuota()) &amp;&amp; (t.getAuditResult() &#x3D;&#x3D; 1 || t.getAuditResult() &#x3D;&#x3D; 3)).count();</span><br><span class="line">                    auditNodes.add(new AuditNode(x.getId(), y.getQuota(), (int) successNum, (int) (filterSum - successNum), x.getBeNum(), x.getDimName(), x.getDimDesc()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            result.add(auditNodes);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.error(&quot;遍历未使用的维度耗时：&#123;&#125;&quot;, System.currentTimeMillis() - start2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        algorithm.calcCDRGini(result, sum, (int) successSum);</span><br><span class="line"></span><br><span class="line">        List&lt;AuditNode&gt; minDime &#x3D; new ArrayList&lt;&gt;(result.size());</span><br><span class="line">        result.forEach(x -&gt; &#123;</span><br><span class="line">            minDime.add(x.stream().sorted(Comparator.comparing(AuditNode::getPrecision)).collect(Collectors.toList()).get(0));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        AuditNode auditNode &#x3D; minDime.stream().sorted(Comparator.comparing(AuditNode::getPrecision)).collect(Collectors.toList()).get(0);</span><br><span class="line"></span><br><span class="line">        return new TreeGrowDto((int) successSum, sum, auditNode);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>1数据库sql构建决策树</p>
<p>​      (1)获取当前决策树未使用的维度若维度使用完全则结束</p>
<p>​      (2)在当前数据集计算每个维度的每个取值的GINI，汇总整个维度的GINI</p>
<p>​      (3)在3基础上选择最小的GINI系数的维度</p>
<p>​      (4)在4基础上进行树的生长</p>
<p>​      (5) 递归调用2</p>
<p>​      空间复杂度为0，时间复杂度均为O(pow(2,m-1)n),基本不可用全当练习。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;递归sql写法</span><br><span class="line">@Override</span><br><span class="line">public void resetTree(String platId, int treeType) &#123;</span><br><span class="line">    AuditNode root &#x3D; new AuditNode();</span><br><span class="line">    root.setId(AppConstant.ROOT);</span><br><span class="line">    tree &#x3D; root;</span><br><span class="line">    growTree(root, platId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private void growTree(AuditNode root, String platId) &#123;</span><br><span class="line">    if (root &#x3D;&#x3D; null)</span><br><span class="line">        return;</span><br><span class="line"></span><br><span class="line">    TreeUtils.print(tree);</span><br><span class="line">    List&lt;AuditNode&gt; nodes &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">    addParents(root, nodes);</span><br><span class="line">    if (nodes.size() &gt; 21)</span><br><span class="line">        return;</span><br><span class="line">    TreeGrowDto treeGrowDto &#x3D; dao.getNodeInfoFromDb(platId, nodes, cart);</span><br><span class="line">    AuditNode leftChild &#x3D; treeGrowDto.getAuditNode();</span><br><span class="line">    leftChild.setBeLeft(true);</span><br><span class="line">    int successCount &#x3D; treeGrowDto.getSuccessCount();</span><br><span class="line">    int sum &#x3D; treeGrowDto.getSum();</span><br><span class="line"></span><br><span class="line">    if (sum &#x3D;&#x3D; 0)</span><br><span class="line">        return;</span><br><span class="line"></span><br><span class="line">    int leftSuccessCount &#x3D; leftChild.getSuccessNum();</span><br><span class="line">    int leftFailCount &#x3D; leftChild.getFailNum();</span><br><span class="line">    int rightSuccessCount &#x3D; successCount - leftSuccessCount;</span><br><span class="line">    int rightFailCount &#x3D; sum - successCount - leftFailCount;</span><br><span class="line"></span><br><span class="line">    log.error(&quot;sum:&#123;&#125; successCount:&#123;&#125; leftSuccessCount:&#123;&#125; leftFailCount:&#123;&#125; rightSuccessCount:&#123;&#125; rightFailCount:&#123;&#125;  &quot;, sum, successCount, leftSuccessCount, leftFailCount, rightSuccessCount, rightFailCount);</span><br><span class="line">    root.setLeftChildNum(leftSuccessCount + leftFailCount);</span><br><span class="line">    root.setRightChildNum(rightFailCount + rightSuccessCount);</span><br><span class="line"></span><br><span class="line">    if (rightSuccessCount !&#x3D; 0 || rightFailCount !&#x3D; 0) &#123;</span><br><span class="line">        AuditNode rightChild &#x3D; leftChild.copy();</span><br><span class="line">        rightChild.setSuccessNum(rightSuccessCount);</span><br><span class="line">        rightChild.setFailNum(rightFailCount);</span><br><span class="line">        rightChild.setBeLeft(false);</span><br><span class="line">        root.setRightChild(rightChild);</span><br><span class="line">        rightChild.setParent(root);</span><br><span class="line">    &#125;</span><br><span class="line">    leftChild.setParent(root);</span><br><span class="line">    root.setLeftChild(leftChild);</span><br><span class="line"></span><br><span class="line">    growTree(root.getRightChild(), platId);</span><br><span class="line">    growTree(leftChild, platId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">String numEqualAppend &#x3D; &quot;  and JSON_UNQUOTE(personas-&gt;?)&gt;&#x3D;?  and JSON_UNQUOTE(personas-&gt;?)&lt;?  &quot;;</span><br><span class="line">    String numNotEqualAppend &#x3D; &quot;  and (JSON_UNQUOTE(personas-&gt;?)&lt;?  or JSON_UNQUOTE(personas-&gt;?)&gt;&#x3D;?)  &quot;;</span><br><span class="line">    String stringEqualAppend &#x3D; &quot;  and JSON_UNQUOTE(personas-&gt;?) &#x3D;? &quot;;</span><br><span class="line">    String stringNotEqualAppend &#x3D; &quot;  and JSON_UNQUOTE(personas-&gt;?) !&#x3D;?  &quot;;</span><br><span class="line">    String successAppend &#x3D; &quot;  and (audit_result&#x3D;3 or audit_result&#x3D;1) &quot;;</span><br><span class="line">    String failAppend &#x3D; &quot;  and (audit_result&#x3D;2 or audit_result&#x3D;4)  &quot;;</span><br><span class="line">    String dollar &#x3D; &quot;$.&quot;;</span><br><span class="line"></span><br><span class="line">    public TreeGrowDto getNodeInfoFromDb(String platId, List&lt;AuditNode&gt; nodes, Cart algorithm) &#123;</span><br><span class="line">        StringBuilder sqlBuild &#x3D; new StringBuilder(&quot;select  count(*)  from audit_history   WHERE plat_id&#x3D;?  &quot;);</span><br><span class="line">        List&lt;Object&gt; params &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        params.add(platId);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;平台全部可用维度</span><br><span class="line">        Map&lt;String, AuditDimension&gt; auditDimensions &#x3D; AppCnst.PLAT_DIM_CACHE.get(platId).stream().collect(Collectors.toMap(AuditDimension::getId, AuditDimension -&gt; AuditDimension));</span><br><span class="line">        &#x2F;&#x2F;决策树已存在的维度ID</span><br><span class="line">        List&lt;String&gt; existNodeDimIds &#x3D; nodes.stream().map(AuditNode::getDimId).collect(Collectors.toList());</span><br><span class="line">        &#x2F;&#x2F;决策树尚未使用的维度ID</span><br><span class="line">      &#x2F;&#x2F;  List&lt;AuditDimension&gt;   unUsedDims&#x3D; auditDimensions.values().stream().filter(x-&gt;!existNodeDimIds.contains(x.getId())).collect(Collectors.toList());</span><br><span class="line">        Map&lt;AuditDimension,List&lt;AuditPlatformQuota&gt;&gt;   unUsedDimQuotaMap&#x3D; AppCnst.PLAT_FORM_QUOTA_CACHE.get(platId).entrySet().stream().filter(x-&gt;!existNodeDimIds.contains(x.getKey())).collect(Collectors.toMap(x-&gt;auditDimensions.get(x.getKey()), Map.Entry::getValue));</span><br><span class="line">        &#x2F;&#x2F;将已使用的维度拼接到sql 确定数据子集</span><br><span class="line">        nodes.forEach(x -&gt; sqlBuild(auditDimensions, x.getDimId(), x.getQuota(), sqlBuild, params, x.getDimName(), x.isBeLeft()));</span><br><span class="line"></span><br><span class="line">        log.info(&quot;sqlBuild:&#123;&#125;&quot;, sqlBuild);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;子集下总的数据量</span><br><span class="line">        int belowSum &#x3D; Db.queryInt(sqlBuild.toString(), params.toArray());</span><br><span class="line">        int belowSuccessSum &#x3D; Db.queryInt(sqlBuild.toString() + successAppend, params.toArray());</span><br><span class="line"></span><br><span class="line">        log.info(&quot;belowSum:&#123;&#125;&quot;, belowSum);</span><br><span class="line">        log.info(&quot;belowSuccessSum:&#123;&#125;&quot;, belowSuccessSum);</span><br><span class="line"></span><br><span class="line">        if(belowSum&#x3D;&#x3D;0)</span><br><span class="line">             log.error(&quot;111111&quot;);</span><br><span class="line">        Collection&lt;List&lt;AuditNode&gt;&gt; result &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        long start2&#x3D;System.currentTimeMillis();</span><br><span class="line">        &#x2F;&#x2F;遍历未使用的维度</span><br><span class="line">        unUsedDimQuotaMap.forEach((x,z)-&gt;&#123;</span><br><span class="line">            &#x2F;&#x2F;此处应注意每次遍历应该初始化sql参数取值 sql取值为stringbuilder转换故无需初始化</span><br><span class="line">            &#x2F;&#x2F;获取每个维度的取值</span><br><span class="line">           &#x2F;&#x2F; List&lt;String&gt;  quotas&#x3D; queryDimQuotas(platId,x.getDimName());</span><br><span class="line">            &#x2F;&#x2F;初始化每个维度的取值的统计信息</span><br><span class="line">            List&lt;AuditNode&gt; auditNodes &#x3D; new ArrayList&lt;&gt;(z.size());</span><br><span class="line">            &#x2F;&#x2F;sql参数添加维度取值 确定该维度下的子集</span><br><span class="line">            &#x2F;&#x2F;遍历每个维度的取值</span><br><span class="line">            z.forEach(y-&gt;&#123;</span><br><span class="line">                String sql &#x3D; sqlBuild.toString();</span><br><span class="line">                &#x2F;&#x2F;数字类型参数 将维度取值进行2的阶乘 进行比较</span><br><span class="line">                if (x.getBeNum()) &#123;</span><br><span class="line">                    double start &#x3D; Math.pow(2, Integer.valueOf(y.getQuota()));</span><br><span class="line">                    double end &#x3D; Math.pow(2, Integer.valueOf(y.getQuota()) + 1);</span><br><span class="line">                    sql +&#x3D; numEqualAppend;</span><br><span class="line">                    params.add(dollar+x.getDimName());</span><br><span class="line">                    params.add(start);</span><br><span class="line">                    params.add(dollar+x.getDimName());</span><br><span class="line">                    params.add(end);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    calcNode(sql, params, auditNodes, x, y.getQuota());</span><br><span class="line">                    params.remove(params.size() - 1);</span><br><span class="line">                    params.remove(params.size() - 1);</span><br><span class="line">                    params.remove(params.size() - 1);</span><br><span class="line">                    params.remove(params.size() - 1);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F;其他类型 直接比较维度取值</span><br><span class="line">                    sql +&#x3D;stringEqualAppend;</span><br><span class="line">                    params.add(dollar+x.getDimName());</span><br><span class="line">                    params.add(y.getQuota());</span><br><span class="line"></span><br><span class="line">                    calcNode(sql, params, auditNodes, x, y.getQuota());</span><br><span class="line">                    params.remove(params.size() - 1);</span><br><span class="line">                    params.remove(params.size() - 1);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            result.add(auditNodes);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        log.error(&quot;遍历未使用的维度耗时：&#123;&#125;&quot;,System.currentTimeMillis()-start2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        algorithm.calcCDRGini(result, belowSum, belowSuccessSum);</span><br><span class="line"></span><br><span class="line">        List&lt;AuditNode&gt; minDime &#x3D; new ArrayList&lt;&gt;(result.size());</span><br><span class="line">        result.forEach(x -&gt; &#123;</span><br><span class="line">            minDime.add(x.stream().sorted(Comparator.comparing(AuditNode::getPrecision)).collect(Collectors.toList()).get(0));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        AuditNode auditNode &#x3D; minDime.stream().sorted(Comparator.comparing(AuditNode::getPrecision)).collect(Collectors.toList()).get(0);</span><br><span class="line"></span><br><span class="line">        return new TreeGrowDto(belowSuccessSum, belowSum, auditNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private void calcNode(String sql, List&lt;Object&gt; params, List&lt;AuditNode&gt; auditNodes, AuditDimension auditDimension, String quota) &#123;</span><br><span class="line">        &#x2F;&#x2F;由于结果只有2种 只需确定2个数据源</span><br><span class="line">        &#x2F;&#x2F;确定子集总的数据量</span><br><span class="line">        int sum &#x3D; Db.queryInt(sql, params.toArray());</span><br><span class="line">        sql +&#x3D; successAppend;</span><br><span class="line">        &#x2F;&#x2F;确定子集总的成功数据量</span><br><span class="line">        int successNum &#x3D; Db.queryInt(sql, params.toArray());</span><br><span class="line">        auditNodes.add(new AuditNode(auditDimension.getId(), quota, successNum, sum - successNum, auditDimension.getBeNum(), auditDimension.getDimName(), auditDimension.getDimDesc()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void sqlBuild(Map&lt;String, AuditDimension&gt; auditDimensions, String dimId, String quota, StringBuilder sqlBuild, List&lt;Object&gt; params, String dimName, boolean beEqual) &#123;</span><br><span class="line">        AuditDimension auditDimension &#x3D; auditDimensions.get(dimId);</span><br><span class="line">        if (auditDimension.getBeNum()) &#123;</span><br><span class="line">            double start &#x3D; Math.pow(2, Integer.valueOf(quota));</span><br><span class="line">            double end &#x3D; Math.pow(2, Integer.valueOf(quota) + 1);</span><br><span class="line">            sqlBuild.append(beEqual ? numEqualAppend : numNotEqualAppend);</span><br><span class="line">            params.add(dollar+dimName);</span><br><span class="line">            params.add(start);</span><br><span class="line">            params.add(dollar+dimName);</span><br><span class="line">            params.add(end);</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            sqlBuild.append(beEqual ? stringEqualAppend : stringNotEqualAppend);</span><br><span class="line">            params.add(dollar+dimName);</span><br><span class="line">            params.add(quota);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>3 魔改CART决策树</p>
<p>前2种在时间和空间上都不友好，并且在我这个实际项目种决策树是需要不断成长，决策在考虑预测值得同时更考量当前决策树分支的连续相同结果数，所以魔改了第三种写法，将递归改为一次分页遍历，虽然决策树模型可能对原生的CART算法有所不同，但也只是决策树节点的顺序可能不一致，根节点保持一致，同时能动态生长即时统计决策树分支的结果数，更满足项目需求，在时间空间上也有较大提升。</p>
<p> (1)将数据信息集每个维度每个取值的结果数入库</p>
<p> (2)计算每个维度每个取值的GINI,汇总整个维度的GINI。</p>
<p> (3)按维度GINI的大小由小到大排序</p>
<p> (4)遍历整个数据结果集进行树的生长</p>
<p>空间时间复杂度：在结果集同步时需要统计每个维度每个取值的成功数，失败数，复杂度跟据取值范围的不同而不同，整体可忽略不计，在决策树动态生成时有对整个结果集遍历，为O(n)，</p>
<p>时间复杂度：只有在决策树动态生成时有对整个结果集遍历，故复杂度为O(n)</p>
<p>将信息分维度入库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * 将数据信息分维度入库</span><br><span class="line">    * @param auditDimensions</span><br><span class="line">    * @param platId</span><br><span class="line">    * @param result</span><br><span class="line">    * @param userPortrait</span><br><span class="line">    * @return</span><br><span class="line">    *&#x2F;</span><br><span class="line">   public boolean insertOrUpdateQuota(List&lt;AuditDimension&gt; auditDimensions, String platId, boolean result, JSONObject userPortrait) &#123;</span><br><span class="line">       Integer successNum &#x3D; result ? 1 : 0;</span><br><span class="line">       Integer failNum &#x3D; result ? 0 : 1;</span><br><span class="line"></span><br><span class="line">       String valueSql &#x3D; &quot; (?, 0, NULL, ?, NULL, NULL, ?, ?, NULL, NULL,null, ?, ?, ?) ,&quot;;</span><br><span class="line">       String updateSql &#x3D; &quot; ON DUPLICATE KEY UPDATE  success_num&#x3D;success_num+? , fail_num&#x3D;fail_num+?&quot;;</span><br><span class="line">       StringBuilder sqlBuild &#x3D; new StringBuilder(&quot;INSERT INTO &#96;mighty_auto_audit&#96;.&#96;audit_platform_quota&#96;(&#96;id&#96;, &#96;del_flag&#96;, &#96;create_by&#96;, &#96;create_date&#96;, &#96;update_by&#96;, &#96;update_date&#96;, &#96;quota&#96;, &#96;dim_id&#96;, &#96;d3_gini&#96;, &#96;c4_gini&#96;, &#96;cart_gini&#96;, &#96;plat_id&#96;, &#96;success_num&#96;, &#96;fail_num&#96;) VALUES &quot;);</span><br><span class="line">       List&lt;Object&gt; objects &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">       String time &#x3D; CommonUtils.now();</span><br><span class="line"></span><br><span class="line">       auditDimensions.forEach(x -&gt; &#123;</span><br><span class="line">           sqlBuild.append(valueSql);</span><br><span class="line">           String dimId &#x3D; x.getId();</span><br><span class="line">           String quota &#x3D; CommonUtils.getInfo(userPortrait, x.getDimName(), x);&#x2F;&#x2F;属性值</span><br><span class="line">           String id &#x3D; CommonUtils.applySha256(quota + dimId + platId);</span><br><span class="line"></span><br><span class="line">           objects.add(id);</span><br><span class="line">           objects.add(time);</span><br><span class="line">           objects.add(quota);</span><br><span class="line">           objects.add(dimId);</span><br><span class="line">           objects.add(platId);</span><br><span class="line">           objects.add(successNum);</span><br><span class="line">           objects.add(failNum);</span><br><span class="line"></span><br><span class="line">       &#125;);</span><br><span class="line">       objects.add(successNum);</span><br><span class="line">       objects.add(failNum);</span><br><span class="line"></span><br><span class="line">       return Db.update(sqlBuild.toString().substring(0, sqlBuild.length() - 1) + updateSql, objects.toArray()) &gt; 0;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>获取维度指标统计信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">public static void resetTree(String platId, TreeAlgorithm algorithm) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        CacheUtils.delPlatTree(platId, algorithm.getTreeType());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;todo 从数据库取数据</span><br><span class="line">        AuditHistoryService auditHistoryService &#x3D; RpcServiceManager.getService(AuditHistoryService.class);</span><br><span class="line">        AuditPlatformQuotaService quotaService &#x3D; RpcServiceManager.getService(AuditPlatformQuotaService.class);</span><br><span class="line">        AuditPlatformService platformService &#x3D; RpcServiceManager.getService(AuditPlatformService.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        auditHistoryService.updateResultHistory(platId);</span><br><span class="line">        platformService.statisticsPlatInfo(platId);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;读取数据库全局统计信息</span><br><span class="line">        AuditPlatform auditPlatform &#x3D; platformService.findById(platId);</span><br><span class="line">        &#x2F;&#x2F;数据库获取指标统计信息</span><br><span class="line">        List&lt;AuditPlatformQuota&gt; platformQuotas &#x3D; quotaService.getAllNodeByPlatId(platId);</span><br><span class="line">        &#x2F;&#x2F;分维度构造指标统计信息</span><br><span class="line">        Map&lt;String, List&lt;AuditNode&gt;&gt; collect &#x3D; platformQuotas.stream().map(AppUtils::change).collect(Collectors.toList()).stream().collect(Collectors.groupingBy(AuditNode::getDimId));</span><br><span class="line">        Collection&lt;List&lt;AuditNode&gt;&gt; collection &#x3D; collect.values();</span><br><span class="line">        &#x2F;&#x2F;统计每个维度以及每个维度取值的gini系数</span><br><span class="line">        int allSuccessCount &#x3D; auditPlatform.getSuccessNum();</span><br><span class="line">        int count &#x3D; allSuccessCount + auditPlatform.getFailNum();</span><br><span class="line">        &#x2F;&#x2F;统计每个维度取值的gini系数</span><br><span class="line">        algorithm.calcCDRGini(collection, count, allSuccessCount);</span><br><span class="line">        &#x2F;&#x2F;维度指标gini系数排序入库</span><br><span class="line">        List&lt;AuditNode&gt; auditNodes &#x3D; quotaService.saveDimGinIDb(collection, platId);</span><br><span class="line">        &#x2F;&#x2F; collection.forEach(x -&gt; saveDimGinIDb(x, platId, auditNodes));</span><br><span class="line">        &#x2F;&#x2F;维度gini系数排序</span><br><span class="line">        List&lt;AuditNode&gt; minDime &#x3D; auditNodes.stream().sorted(Comparator.comparing(AuditNode::getPrecision)).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;新增叶子节点</span><br><span class="line">        &#x2F;&#x2F;TODO 好像有点多余但与算法绑定 待优化</span><br><span class="line">        AuditNode leaf &#x3D; new AuditNode();</span><br><span class="line">        leaf.setBeLeaf(true);</span><br><span class="line">        leaf.setDimDesc(&quot;叶子节点&quot;);</span><br><span class="line">        leaf.setQuota(&quot;叶子节点&quot;);</span><br><span class="line">        minDime.add(leaf);</span><br><span class="line">        &#x2F;&#x2F;取最小的为根节点</span><br><span class="line">        AuditNode root &#x3D; minDime.get(0).copy();</span><br><span class="line">        root.setBeLeft(true);</span><br><span class="line">        &#x2F;&#x2F; root.setParentId(AppConstant.ROOT);</span><br><span class="line">        root.setId(AppConstant.ROOT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        CacheUtils.delPlatTreeDim(platId, algorithm.getTreeType());</span><br><span class="line">        CacheUtils.setPlatTreeDim(platId, algorithm.getTreeType(), minDime);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;重新取数据库数据 同时进行决策树构造和决策数据统计</span><br><span class="line">        int pageNum &#x3D; AppConstant.DEFAULT_PAGE_NUM;</span><br><span class="line">        int pageSize &#x3D; AppConstant.DEFAULT_PAGE_SIZE * AppConstant.DEFAULT_PAGE_SIZE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        List&lt;AuditHistory&gt; auditHistories &#x3D; null;</span><br><span class="line">        long start &#x3D; System.currentTimeMillis();</span><br><span class="line">        while (CollectionUtils.isNotEmpty((auditHistories &#x3D; auditHistoryService.getUsedHistory(platId, pageNum, pageSize)))) &#123;</span><br><span class="line">            log.info(&quot;决策树重构分页取值&#123;&#125;个耗时&#123;&#125;&quot;, auditHistories.size(), System.currentTimeMillis() - start);</span><br><span class="line">            start &#x3D; System.currentTimeMillis();</span><br><span class="line">            log.info(&quot;维度信息:&#123;&#125;&quot;, JsonUtils.toString(minDime));</span><br><span class="line"></span><br><span class="line">            algorithm.makeDecisionTree(auditHistories, root, minDime, platId, algorithm.getTreeType());</span><br><span class="line">            pageNum++;</span><br><span class="line">            log.info(&quot;决策树重构分页取值&#123;&#125;个耗时:&#123;&#125;&quot;, auditHistories.size(), System.currentTimeMillis() - start);</span><br><span class="line">            start &#x3D; System.currentTimeMillis();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;        DecisionTreeManager.getDecisionTree(root, platId, DecisionTree.CART.getType());</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">        TreeUtils.print(root);</span><br><span class="line">        AppCnst.PLAT_TREE_CACHE.put(platId + algorithm.getTreeType(), root);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;   AppCnst.TREE.put(platId + algorithm.getTreeType(), root);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;   saveDecisionTree(root, platId, algorithm.getTreeType(), &quot;&quot;, auditDecisionTreeService);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>维度GINI信息入库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public List&lt;AuditNode&gt; saveDimGinIDb(Collection&lt;List&lt;AuditNode&gt;&gt; dimGinis, String platId) &#123;</span><br><span class="line">       List&lt;AuditNode&gt; auditNodes &#x3D; new ArrayList&lt;&gt;(dimGinis.size());</span><br><span class="line">       List&lt;AuditDimension&gt; auditDimensions &#x3D; new ArrayList&lt;&gt;(dimGinis.size());</span><br><span class="line">       if (!Db.tx(() -&gt; &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               dimGinis.forEach(x -&gt; &#123;</span><br><span class="line">                   &#x2F;&#x2F;更新平台维度指标的gini系数</span><br><span class="line">                   List&lt;AuditPlatformQuota&gt; platformQuotas &#x3D; x.stream().map(CommonUtils::change).sorted(Comparator.comparing(AuditPlatformQuota::getCartGini)).collect(Collectors.toList());</span><br><span class="line">                  &#x2F;&#x2F; if (!saveOrUpdateQuota(platId, platformQuotas))</span><br><span class="line">                   &#x2F;&#x2F;    ErrorUtils.error(&quot;更新平台维度指标的gini系数 更新失败&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                   &#x2F;&#x2F;取出最小的平台维度指标gini系数</span><br><span class="line">                   AuditNode min &#x3D; CommonUtils.change(platformQuotas.get(0));</span><br><span class="line">                   min.setIndex(auditNodes.size());</span><br><span class="line">                   auditNodes.add(min);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                   AuditDimension auditDimension &#x3D; new AuditDimension();</span><br><span class="line">                   auditDimension.setId(min.getDimId());</span><br><span class="line">                   auditDimension.setCartGini(min.getPrecision());</span><br><span class="line">                   auditDimensions.add(auditDimension);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">               &#125;);</span><br><span class="line">               &#x2F;&#x2F;更新平台维度的gini系数</span><br><span class="line">               auditDimensionDao.batchUpdate(auditDimensions);</span><br><span class="line"></span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               log.error(&quot;&quot;, e);</span><br><span class="line">               return false;</span><br><span class="line">           &#125;</span><br><span class="line">           return true;</span><br><span class="line">       &#125;)) &#123;</span><br><span class="line">           return Collections.emptyList();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return auditNodes;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>决策树构建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">    @Override</span><br><span class="line">    public void makeDecisionTree(List&lt;AuditHistory&gt; userPortraits, AuditNode root, List&lt;AuditNode&gt; minDime, String platId, Integer treeType) &#123;</span><br><span class="line">        &#x2F;&#x2F;  userPortraits.stream().parallel().forEach(x -&gt; &#123;</span><br><span class="line"></span><br><span class="line">        userPortraits.forEach(x -&gt; &#123;</span><br><span class="line">            x.setBeUsed(true);</span><br><span class="line">            Map&lt;String, AuditNode&gt; auditNodeMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">            changeTree(root, JSONObject.parseObject(x.getPersonas()), minDime, AppUtils.auditResult(x.getAuditResult()), platId, treeType, auditNodeMap);</span><br><span class="line">            CacheUtils.hmsetPlatTree(platId, treeType, auditNodeMap);</span><br><span class="line">            &#x2F;&#x2F;   auditNodeMap.values().forEach(z -&gt; CacheUtils.setPlatTree(platId, treeType, z));</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">      &#x2F;**</span><br><span class="line">     * 本方法将数据全部全部存入内存 刷新redis 用于数据量小的时候使用 速度较快</span><br><span class="line">     *</span><br><span class="line">     * @param root</span><br><span class="line">     * @param userPortrait</span><br><span class="line">     * @param minDime</span><br><span class="line">     * @param resultMatch</span><br><span class="line">     * @param platId</span><br><span class="line">     * @param treeType</span><br><span class="line">     * @param map</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public void changeTree(AuditNode root, JSONObject userPortrait, List&lt;AuditNode&gt; minDime, boolean resultMatch, String platId, Integer treeType, Map&lt;String, AuditNode&gt; map) &#123;</span><br><span class="line">        if (root &#x3D;&#x3D; null)</span><br><span class="line">            return;</span><br><span class="line"></span><br><span class="line">        if (test(root))</span><br><span class="line">            log.info(&quot;维度信息:&#123;&#125;&quot;, JsonUtils.toString(minDime));</span><br><span class="line"></span><br><span class="line">        if (resultMatch)</span><br><span class="line">            root.setSuccessNum(root.getSuccessNum() + 1);</span><br><span class="line">        else</span><br><span class="line">            root.setFailNum(root.getFailNum() + 1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if (root.isBeLeaf()) &#123;</span><br><span class="line">            if (resultMatch) &#123;</span><br><span class="line">                root.setSerialSuccessNum(root.getSerialSuccessNum() + 1);</span><br><span class="line">                root.setSerialFailNum(0);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                root.setSerialFailNum(root.getSerialFailNum() + 1);</span><br><span class="line">                root.setSerialSuccessNum(0);</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; CacheUtils.setPlatTree(platId, treeType, root);</span><br><span class="line">            map.put(root.getId(), root);</span><br><span class="line"></span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;获取当前维度的取值以及当前用户画像对应取值</span><br><span class="line">        String userQuota &#x3D; CommonUtils.getInfo(userPortrait, root.getDimName(), root);</span><br><span class="line">        String quota &#x3D; root.getQuota();</span><br><span class="line">        boolean quotaEqual &#x3D; StringUtils.equals(userQuota, quota);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;获取子节点</span><br><span class="line">        int nextIndex &#x3D; root.getIndex() + 1;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;  String parentId &#x3D; CommonUtils.applySha256(root.getId()+root.isBeLeft());</span><br><span class="line">        String parentId &#x3D; root.getId();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;相等走左边 构建左节点 更新父节点统计信息</span><br><span class="line">        if (quotaEqual) &#123;</span><br><span class="line">            AuditNode leftChild &#x3D; root.getLeftChild();</span><br><span class="line">            &#x2F;&#x2F;  AuditNode leftChild &#x3D; CacheUtils.getPlatTree(platId, treeType, parentId, true);</span><br><span class="line">            &#x2F;&#x2F; AuditNode leftChild &#x3D; CommonUtils.getNodeRedisOrMap(map, platId, treeType, parentId, true);</span><br><span class="line">            if (leftChild &#x3D;&#x3D; null) &#123;</span><br><span class="line">                leftChild &#x3D; minDime.get(nextIndex).copy();</span><br><span class="line">                leftChild.setIndex(nextIndex);</span><br><span class="line">                leftChild.setParent(root);</span><br><span class="line">                leftChild.setBeLeft(true);</span><br><span class="line">                leftChild.setParentId(parentId);</span><br><span class="line">                leftChild.setId(parentId + CommonUtils.change(leftChild.isBeLeft()));</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F;  CacheUtils.setPlatTree(platId, treeType, leftChild);</span><br><span class="line">                map.put(leftChild.getId(), leftChild);</span><br><span class="line">                &#x2F;&#x2F;  leftChild.setId(CommonUtils.applySha256(parentId +leftChild.isBeLeft()));</span><br><span class="line">                root.setLeftChild(leftChild);</span><br><span class="line">            &#125;</span><br><span class="line">            if (resultMatch)</span><br><span class="line">                root.setLeftChildSuccessNum(root.getLeftChildSuccessNum() + 1);</span><br><span class="line">            else</span><br><span class="line">                root.setLeftChildFailNum(root.getLeftChildFailNum() + 1);</span><br><span class="line"></span><br><span class="line">            root.setLeftChildNum(root.getLeftChildNum() + 1);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;            CacheUtils.setPlatTree(platId, treeType, root);</span><br><span class="line">            map.put(root.getId(), root);</span><br><span class="line"></span><br><span class="line">            changeTree(leftChild, userPortrait, minDime, resultMatch, platId, treeType, map);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;不等走右边 构建右节点 更新父节点统计信息</span><br><span class="line">        AuditNode rightChild &#x3D; root.getRightChild();</span><br><span class="line">        &#x2F;&#x2F; AuditNode rightChild &#x3D; CacheUtils.getPlatTree(platId, treeType, parentId, false);</span><br><span class="line">        &#x2F;&#x2F; AuditNode rightChild &#x3D; CommonUtils.getNodeRedisOrMap(map, platId, treeType, parentId, false);</span><br><span class="line"></span><br><span class="line">        if (rightChild &#x3D;&#x3D; null) &#123;</span><br><span class="line">            rightChild &#x3D; minDime.get(nextIndex).copy();</span><br><span class="line">            rightChild.setIndex(nextIndex);</span><br><span class="line">            rightChild.setParent(root);</span><br><span class="line">            rightChild.setParentId(parentId);</span><br><span class="line">            &#x2F;&#x2F;  rightChild.setId(CommonUtils.applySha256(parentId +rightChild.isBeLeft()));</span><br><span class="line">            rightChild.setId(parentId + CommonUtils.change(rightChild.isBeLeft()));</span><br><span class="line"></span><br><span class="line">            root.setRightChild(rightChild);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; CacheUtils.setPlatTree(platId, treeType, rightChild);</span><br><span class="line">            map.put(rightChild.getId(), rightChild);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (resultMatch)</span><br><span class="line">            root.setRightChildSuccessNum(root.getRightChildSuccessNum() + 1);</span><br><span class="line">        else</span><br><span class="line">            root.setRightChildFailNum(root.getRightChildFailNum() + 1);</span><br><span class="line"></span><br><span class="line">        root.setRightChildNum(root.getRightChildNum() + 1);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;  CacheUtils.setPlatTree(platId, treeType, root);</span><br><span class="line">        map.put(root.getId(), root);</span><br><span class="line"></span><br><span class="line">        changeTree(rightChild, userPortrait, minDime, resultMatch, platId, treeType, map);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="预测"><a href="#预测" class="headerlink" title="预测"></a>预测</h2><p>​      本预测为魔改版决策树根据当前连续相同结果数进行预测。</p>
<p>​       预测结果类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @Desc 智能审核结果数据集</span><br><span class="line"> * @Author Yu Zhao</span><br><span class="line"> * @Date 2020&#x2F;11&#x2F;7 14:26</span><br><span class="line"> * @Version 1.0</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Getter</span><br><span class="line">@Setter</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public class AiAuditResult implements Serializable &#123;</span><br><span class="line"></span><br><span class="line">    private Integer auditResult;</span><br><span class="line">    private Double cartPrecision;</span><br><span class="line">    private Integer serialFailNum;</span><br><span class="line">    private Integer serialSuccessNum;</span><br><span class="line">    private Integer successNum;</span><br><span class="line">    private Integer failNum;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>预测实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">private AuditNode getChild(AuditNode root, JSONObject userPortrait, String platId, Integer treeType) &#123;</span><br><span class="line">    String quota &#x3D; root.getQuota();</span><br><span class="line">    String dimension &#x3D; root.getDimName();</span><br><span class="line">    String info &#x3D; userPortrait.getString(dimension);</span><br><span class="line">    info &#x3D; root.isBeNum() ? CommonUtils.toBinaryLength(info) : info;</span><br><span class="line">    boolean equal &#x3D; StringUtils.equals(info, quota);</span><br><span class="line">    return equal ? root.getLeftChild() : root.getRightChild();</span><br><span class="line">    &#x2F;&#x2F;return equal ? CacheUtils.getTreeLeftChild(platId, treeType, root.getId()) : CacheUtils.getTreeRightChild(platId, treeType, root.getId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public AiAuditResult treePrecision(AuditNode root, JSONObject userPortrait, AuditPlatform auditPlatform, List&lt;AuditNode&gt; dims, String platId, Integer treeType) &#123;</span><br><span class="line">    log.info(&quot;root:&#123;&#125;&quot;, root &#x3D;&#x3D; null ? &quot;sad&quot; : root.getDimDesc());</span><br><span class="line">    AuditNode child &#x3D; getChild(root, userPortrait, platId, treeType);</span><br><span class="line">    &#x2F;&#x2F;叶子节点不为空 递归</span><br><span class="line">    if (child !&#x3D; null) &#123;</span><br><span class="line">        return treePrecision(child, userPortrait, auditPlatform, dims, platId, treeType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;到达叶子节点</span><br><span class="line">    if (root.isBeLeaf()) &#123;</span><br><span class="line">        log.info(&quot;当前连续审核成功数&#123;&#125;失败数&#123;&#125;,配置数&#123;&#125;&quot;, root.getSerialSuccessNum(), root.getSerialFailNum(), auditPlatform.getContinuity());</span><br><span class="line">        if (root.getSerialSuccessNum() &gt;&#x3D; auditPlatform.getContinuity())</span><br><span class="line">            return setAuditResult(AuditResult.AI_YES, 1.0, root);</span><br><span class="line"></span><br><span class="line">        if (root.getSerialFailNum() &gt;&#x3D; auditPlatform.getContinuity())</span><br><span class="line">            return setAuditResult(AuditResult.AI_NO, 0.0, root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.info(&quot;走入决策树不存在的路径&quot;);</span><br><span class="line">    &#x2F;&#x2F;todo 当叶子节点不存在时对结果进行预测 当前只按总成功率 应该对剩余维度取值汇总gini</span><br><span class="line">    return setAuditResult(root);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private AiAuditResult setAuditResult(AuditNode root) &#123;</span><br><span class="line">    AiAuditResult aiAuditResult &#x3D; new AiAuditResult();</span><br><span class="line">    aiAuditResult.setAuditResult(AuditResult.DEALUT.getResult());</span><br><span class="line">    aiAuditResult.setCartPrecision((double) root.getSuccessNum() &#x2F; (root.getSuccessNum() + root.getFailNum()));</span><br><span class="line">    aiAuditResult.setSuccessNum(root.getSuccessNum());</span><br><span class="line">    aiAuditResult.setFailNum(root.getFailNum());</span><br><span class="line">    aiAuditResult.setSerialFailNum(root.getSerialFailNum());</span><br><span class="line">    aiAuditResult.setSerialSuccessNum(root.getSerialSuccessNum());</span><br><span class="line">    return aiAuditResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private AiAuditResult setAuditResult(AuditResult auditResult, double precision, AuditNode root) &#123;</span><br><span class="line">    AiAuditResult aiAuditResult &#x3D; new AiAuditResult();</span><br><span class="line">    aiAuditResult.setAuditResult(auditResult.getResult());</span><br><span class="line">    aiAuditResult.setCartPrecision(precision);</span><br><span class="line">    aiAuditResult.setSerialFailNum(root.getSerialFailNum());</span><br><span class="line">    aiAuditResult.setSerialSuccessNum(root.getSerialSuccessNum());</span><br><span class="line">    aiAuditResult.setSuccessNum(root.getSuccessNum());</span><br><span class="line">    aiAuditResult.setFailNum(root.getFailNum());</span><br><span class="line"></span><br><span class="line">    return aiAuditResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="剪枝"><a href="#剪枝" class="headerlink" title="剪枝"></a>剪枝</h2><p>​     决策树过于冗余时需要进行剪枝，剪枝分为前剪枝后剪枝。</p>
<p>​     前剪枝(未实现)</p>
<p>​     通过提前停止树的构建而对树剪枝，一旦停止，节点就是树叶，该树叶持有子集元祖最频繁的类。停止决策树生长最简单的方法有：</p>
<p>(1).定义一个高度，当决策树达到该高度时就停止决策树的生长</p>
<p>(2).达到某个节点的实例具有相同的特征向量，及时这些实例不属于同一类，也可以停止决策树的生长。</p>
<p>​    后剪枝</p>
<p>​    (1)CCP代价复杂度剪枝 <a target="_blank" rel="noopener" href="https://blog.csdn.net/Oscar6280868/article/details/86158170">详情参考</a></p>
<p>​                R ( t ) 表示进行剪枝之后的该节点误差，R ( T t ) 表示未进行剪枝时子树T t的误差，通常我们用∣ L ( T t ) ∣ 表示子树T t 的叶子节点个数，那么树在节点t 处剪枝后的误差增加率可以表示为：<br>$$<br>α=(R(t)-R(Tt))/(|L(Tt)|-1<br>$$<br>统计子节点个数</p>
<p>​        </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"> public static void trimDecisionTree(AuditNode root) &#123;</span><br><span class="line">        if (root &#x3D;&#x3D; null)</span><br><span class="line">            return;</span><br><span class="line">        if (StringUtils.isBlank(root.getQuota())) &#123;</span><br><span class="line">            parentAddLeafNum(root.isBeLeft(), root.getParent());</span><br><span class="line">            &#x2F;&#x2F;log.info(&quot;&#123;&#125;ZZZZZZZZZZZZZ&quot;, root.getIndex());</span><br><span class="line">        &#125;</span><br><span class="line">        if (root.getLeftChildFailNum() &#x3D;&#x3D; 0 || root.getLeftChildSuccessNum() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            AuditNode leftChild &#x3D; root.getLeftChild();</span><br><span class="line">            root.setLeftChild(null);</span><br><span class="line">        &#125;</span><br><span class="line">        if (root.getRightChildFailNum() &#x3D;&#x3D; 0 || root.getRightChildSuccessNum() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            AuditNode rightChild &#x3D; root.getRightChild();</span><br><span class="line">            root.setRightChild(null);</span><br><span class="line">        &#125;</span><br><span class="line">        trimDecisionTree(root.getLeftChild());</span><br><span class="line">        trimDecisionTree(root.getRightChild());</span><br><span class="line"></span><br><span class="line">        if (root.getLeftChildFailNum() &#x3D;&#x3D; 0 || root.getLeftChildSuccessNum() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            AuditNode leftChild &#x3D; root.getLeftChild();</span><br><span class="line">            root.setLeftChild(null);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;            if (leftChild !&#x3D; null) &#123;</span><br><span class="line">&#x2F;&#x2F;                root.setSerialLeftSuccessNum(leftChild.getSerialSuccessNum());</span><br><span class="line">&#x2F;&#x2F;                root.setSerialLeftFailNum(leftChild.getSerialFailNum());</span><br><span class="line">&#x2F;&#x2F;                root.setLeftChild(null);</span><br><span class="line">&#x2F;&#x2F;            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (root.getRightChildFailNum() &#x3D;&#x3D; 0 || root.getRightChildSuccessNum() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            AuditNode rightChild &#x3D; root.getRightChild();</span><br><span class="line">            root.setRightChild(null);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;            if (rightChild !&#x3D; null) &#123;</span><br><span class="line">&#x2F;&#x2F;                root.setSerialRightSuccessNum(rightChild.getSerialSuccessNum());</span><br><span class="line">&#x2F;&#x2F;                root.setSerialLeftFailNum(rightChild.getSerialFailNum());</span><br><span class="line">&#x2F;&#x2F;                root.setRightChild(null);</span><br><span class="line">&#x2F;&#x2F;            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (root.getRightChildNum() &#x3D;&#x3D; 0 || root.getLeftChildNum() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            if (root.isBeLeft())</span><br><span class="line">                root.getParent().setLeftChild(null);</span><br><span class="line">            else</span><br><span class="line">                root.getParent().setRightChild(null);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void parentAddLeafNum(boolean beLeft, AuditNode node) &#123;</span><br><span class="line">        if (node &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (beLeft) &#123;</span><br><span class="line">            node.setLeftLeafNum(node.getLeftLeafNum() + 1);</span><br><span class="line">            parentAddLeafNum(beLeft, node.getParent());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            node.setRightLeafNum(node.getRightLeafNum() + 1);</span><br><span class="line">            parentAddLeafNum(beLeft, node.getParent());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>计算代价复杂度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public static void trimByCCP(AuditNode root, Map&lt;AuditNode, Double&gt; map) &#123;</span><br><span class="line">       if (root &#x3D;&#x3D; null || StringUtils.isBlank(root.getQuota())) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       double rate &#x3D; trimByCCPAndNode(root);</span><br><span class="line"></span><br><span class="line">       log.info(&quot;&#123;&#125;,&#123;&#125;,&#123;&#125;指标 &#123;&#125;误差增加率 &#123;&#125;&quot;, root.isBeLeft(), root.getDimName(), root.getDimId(), root.getQuota(), rate);</span><br><span class="line">       map.put(root, rate);</span><br><span class="line">       trimByCCP(root.getRightChild(), map);</span><br><span class="line">       trimByCCP(root.getLeftChild(), map);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public static double trimByCCPAndNode(AuditNode root) &#123;</span><br><span class="line"></span><br><span class="line">       int Rt &#x3D; root.isBeLeft() ? root.getFailNum() : root.getSuccessNum();</span><br><span class="line"></span><br><span class="line">       AtomicInteger RTt &#x3D; new AtomicInteger(0);</span><br><span class="line">       AtomicInteger LTt &#x3D; new AtomicInteger(0);</span><br><span class="line">       trimRLTt(root, RTt, LTt);</span><br><span class="line">       log.info(&quot;&#123;&#125;&quot;, Rt);</span><br><span class="line">       log.info(&quot;&#123;&#125;&quot;, RTt.get());</span><br><span class="line">       log.info(&quot;&#123;&#125;&quot;, LTt.get());</span><br><span class="line"></span><br><span class="line">       return (Rt - RTt.get()) &#x2F; (double) (LTt.get() - 1);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   public static void trimRLTt(AuditNode root, AtomicInteger RTt, AtomicInteger LTt) &#123;</span><br><span class="line">       if (root &#x3D;&#x3D; null)</span><br><span class="line">           return;</span><br><span class="line">       boolean left &#x3D; root.getLeftChild() !&#x3D; null &amp;&amp; StringUtils.isNotBlank(root.getLeftChild().getQuota());</span><br><span class="line">       boolean right &#x3D; root.getRightChild() !&#x3D; null &amp;&amp; StringUtils.isNotBlank(root.getRightChild().getQuota());</span><br><span class="line">       if (left) &#123;</span><br><span class="line">           trimRLTt(root.getLeftChild(), RTt, LTt);</span><br><span class="line">       &#125;</span><br><span class="line">       if (right) &#123;</span><br><span class="line">           trimRLTt(root.getRightChild(), RTt, LTt);</span><br><span class="line">       &#125;</span><br><span class="line">       if (!left &amp;&amp; !right) &#123;</span><br><span class="line">           LTt.addAndGet(2);</span><br><span class="line">           RTt.addAndGet(root.getLeftChildFailNum() + root.getRightChildSuccessNum());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>map由代价复杂度取最小值后进行剪枝</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static void cutDecisionTree(AuditNode root, AuditNode cutNode) &#123;</span><br><span class="line">    if (root &#x3D;&#x3D; null || StringUtils.isBlank(root.getQuota()) || cutNode.getIndex() &lt; root.getIndex())</span><br><span class="line">        return;</span><br><span class="line">    if (cutNode.getIndex() &#x3D;&#x3D; root.getIndex() &amp;&amp; StringUtils.equals(root.getQuota(), cutNode.getQuota()) &amp;&amp; cutNode.isBeLeft() &#x3D;&#x3D; root.isBeLeft()</span><br><span class="line">            &amp;&amp; cutNode.getSuccessNum() &#x3D;&#x3D; root.getSuccessNum() &amp;&amp; cutNode.getFailNum() &#x3D;&#x3D; root.getFailNum()) &#123;</span><br><span class="line">        log.error(&quot;找到剪纸节点&quot;);</span><br><span class="line">        if (cutNode.isBeLeft())</span><br><span class="line">            root.getParent().setLeftChild(null);</span><br><span class="line">        else</span><br><span class="line">            root.getParent().setRightChild(null);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    cutDecisionTree(root.getLeftChild(), cutNode);</span><br><span class="line">    cutDecisionTree(root.getRightChild(), cutNode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>(2)PEP—悲观剪枝算法  <a target="_blank" rel="noopener" href="https://www.cnblogs.com/starfire86/p/5749334.html">详情参考</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public static void cutDTByPEP(AuditNode root) &#123;</span><br><span class="line">    if (root &#x3D;&#x3D; null)</span><br><span class="line">        return;</span><br><span class="line">    AtomicInteger RTt &#x3D; new AtomicInteger(0);</span><br><span class="line">    AtomicInteger LTt &#x3D; new AtomicInteger(0);</span><br><span class="line">    trimRLTt(root, RTt, LTt);</span><br><span class="line">    double ESUBTREE &#x3D; RTt.get() + 0.5 * (root.getLeftLeafNum() + root.getRightLeafNum());</span><br><span class="line">    double SESUBTREE &#x3D; Math.sqrt(ESUBTREE * (1 - ESUBTREE &#x2F; (double) (root.getLeftChildNum() + root.getRightChildNum())));</span><br><span class="line">    double EIEAF &#x3D; root.getLeftChildSuccessNum() + root.getRightChildSuccessNum() + 0.5;</span><br><span class="line"></span><br><span class="line">    if (ESUBTREE &lt; SESUBTREE + EIEAF) &#123;</span><br><span class="line">        log.error(&quot;&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;符合PEP—悲观剪枝算法&#123;&#125;,&#123;&#125;,&#123;&#125;&quot;, root.getDimName(), root.isBeLeft(), root.getQuota(), root.getIndex(), ESUBTREE, SESUBTREE, EIEAF);</span><br><span class="line">        if (root.getParent() !&#x3D; null) &#123;</span><br><span class="line">            if (root.isBeLeft())</span><br><span class="line">                root.getParent().setLeftChild(null);</span><br><span class="line">            root.getParent().setRightChild(null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        cutDTByPEP(root.getLeftChild());</span><br><span class="line">        cutDTByPEP(root.getRightChild());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>​        本算法本渣渣也是现学现卖有任何不对或者不清楚地方欢迎加扣扣讨论学习。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">宇昭</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2020/11/18/blog-4/">http://example.com/2020/11/18/blog-4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">可乐不加冰</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AE%97%E6%B3%95/">算法</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/07/blog-5/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SECP256_K1椭圆曲线签名算法</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/18/blog-3/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">决策树C4.5</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/11/18/blog-3/" title="决策树C4.5"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-18</div><div class="title">决策树C4.5</div></div></a></div><div><a href="/2020/11/17/my-second/" title="决策树ID3"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-17</div><div class="title">决策树ID3</div></div></a></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By 宇昭</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@latest/Hexo/js/mouse_snow.min.js"></script></div></body></html>